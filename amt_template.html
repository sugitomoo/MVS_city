<style>
    .amt-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    .instructions {
        background: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .instructions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 25px;
    }
    .instructions-column h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-column ul {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-column li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .instructions-workflow h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-workflow ol {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-workflow li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .iframe-container {
        width: 100%;
        height: 850px;
        border: 2px solid #ddd;
        border-radius: 5px;
    }
    #annotation-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
</style>

<div class="amt-container">
    <div class="instructions">
        <h2>Multi-Video Summarization Task</h2>
        <p>In this task, you will watch 5 videos about <strong>${city_name}</strong> and select the most representative, impressive, and unique scenes that best summarize the city across the entire video collection.</p>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid #ffeaa7;">
            <strong>⚠️ IMPORTANT:</strong> You MUST click "Save Results" button (located below the statistics) BEFORE clicking "Return HIT". 
            Only return the HIT after you see the "Task completed successfully!" message.
        </div>
        
        <div class="instructions-grid">
            <div class="instructions-column">
                <h3>Selection Criterion</h3>
                <ul>
                    <li>Please first watch all videos, then, choose the most attractive, clear, or visually impressive segments from all segments.</li>
                    <li>If a similar scene appears in other videos, avoid duplication.</li>
                    <li>If the same content exists in multiple videos, choose only the most attractive, clear, or visually impressive version.</li>
                    <li>The total length of selected segments across all videos should be between <strong>5% and 15%</strong> of the overall content.</li>
                    <li>Focus on scenes that are unique and valuable, ideally those only visible in that specific video.</li>
                    <li>Audio is muted, so please base your judgment only on visuals.</li>
                    <li>Do not consider temporary on-screen text (subtitles, overlays) as the main reason to judge importance.</li>
                </ul>
            </div>
            
            <div class="instructions-column">
                <h3>Interface Operations</h3>
                <ul>
                    <li><strong>Video Navigation:</strong> Use video controls to play, pause, and seek through videos.</li>
                    <li><strong>Segment Selection:</strong> Click on segment tiles to jump to that segment in the video.</li>
                    <li><strong>Include/Remove:</strong> Click the "Include" button on segment tiles to select them for the summary.</li>
                    <li><strong>Quick Include:</strong> Use the "Include Current Segment" button to select the segment at current playback position.</li>
                    <li><strong>Progress Bar:</strong> Click on the progress bar to jump to specific times.</li>
                    <li><strong>Segment Boundaries:</strong> Visual boundaries on the progress bar show segment divisions.</li>
                    <li><strong>Statistics:</strong> Monitor your selection progress using the stats at the top.</li>
                    <li><strong>Save:</strong> Click "Save Results" when finished to submit your selections.</li>
                </ul>
            </div>
        </div>
        
        <div class="instructions-workflow">
            <h3>Workflow</h3>
            <ol>
                <li>Check the name of the tourist city provided as the query.</li>
                <li>Watch all videos related to the city.</li>
                <li>From each video, select important segments that best express the city's characteristics and appeal.</li>
                <li>Check for duplicate content across videos.</li>
                <li>If a similar segment has already been selected from another video, choose only the best version and discard the redundant one.</li>
                <li>After selecting, double-check that the final summary covers all key aspects of the city without unnecessary repetition or omissions.</li>
                <li>Press the "Save" button to submit your results.</li>
            </ol>
        </div>
    </div>
    
    <div class="iframe-container">
        <iframe id="annotation-iframe"></iframe>
    </div>
    
    <!-- Status and submission section -->
    <div style="background: #f0f0f0; padding: 20px; margin-top: 20px; border-radius: 8px; text-align: center;">
        <div id="status-message" style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">
            Please complete your selection in the interface above.
        </div>
        <button id="save-results-btn" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-right: 10px;">
            Save Results
        </button>
        <button id="return-hit-btn" style="background: #f44336; color: white; border: none; padding: 12px 30px; border-radius: 5px; font-size: 16px; cursor: pointer; display: none;">
            Return HIT
        </button>
        <div id="completion-message" style="display: none; margin-top: 15px; color: #4CAF50; font-size: 18px;">
            ✓ Task completed successfully! You can now safely return this HIT.
        </div>
    </div>
    
    <!-- Hidden form for AMT submission -->
    <crowd-form id="mturk-form" style="display: none;">
        <crowd-input name="results" type="hidden" id="results-input" />
        <crowd-input name="city" type="hidden" value="${city_name}" />
        <crowd-input name="area" type="hidden" value="${area}" />
        <crowd-input name="place" type="hidden" value="${place}" />
    </crowd-form>
</div>

<script>
    const GITHUB_PAGES_URL = 'https://sugitomoo.github.io/MVS_city/';
    const GITHUB_PAGES_ORIGIN = 'https://sugitomoo.github.io';

    const cityData = {
        area: '${area}',
        place: '${place}',
        cityName: '${city_name}',
        videoIds: [
            '${video1_id}',
            '${video2_id}',
            '${video3_id}',
            '${video4_id}',
            '${video5_id}'
        ]
    };
    
    // Initialize iframe
    const iframe = document.getElementById('annotation-iframe');
    const params = new URLSearchParams({
        area: cityData.area,
        place: cityData.place,
        city: cityData.cityName,
        videos: cityData.videoIds.join(','),
        mode: 'amt'
    });
    
    iframe.src = GITHUB_PAGES_URL + '?' + params.toString();
    
    let currentResults = null;
    let taskCompleted = false;
    
    // Save Results button handler
    document.getElementById('save-results-btn').addEventListener('click', function() {
        // Send message to iframe to save results
        iframe.contentWindow.postMessage({ type: 'save-request' }, '*');
    });
    
    // Return HIT button handler
    document.getElementById('return-hit-btn').addEventListener('click', () => {
        if (confirm('Are you sure you want to return this HIT? Your selection has been saved.')) {
            // Here you would normally trigger the AMT return function
            // For now, just show a message
            alert('You can now click the "Return HIT" button at the top of this page.');
        }
    });
    
    // Listen for messages from iframe
    window.addEventListener('message', event => {
        // GitHub Pages origin 以外は無視
        if (event.origin !== GITHUB_PAGES_ORIGIN) return;
        
        if (event.data.type === 'results-saved') {
            currentResults = event.data.results;
            
            // Check if percentage is within 5-15% range
            if (currentResults.percentage >= 5 && currentResults.percentage <= 15) {
                // Save to hidden form
                document.getElementById('results-input').value = JSON.stringify(currentResults);
                
                // Update UI
                document.getElementById('status-message').innerHTML = 
                    '<span style="color: #4CAF50;">✓ Selection saved! (' + currentResults.percentage.toFixed(1) + '% selected)</span>';
                document.getElementById('save-results-btn').style.display = 'none';
                document.getElementById('return-hit-btn').style.display = 'inline-block';
                document.getElementById('completion-message').style.display = 'block';
                
                taskCompleted = true;
                
                // Submit the form to save data
                document.getElementById('mturk-form').submit();
            } else {
                document.getElementById('status-message').innerHTML =
                  `<span style="color: #f44336;">Selection must be between 5% and 15%. Current: ${currentResults.percentage.toFixed(1)}%</span>`;
                alert(
                  `Selection must be between 5% and 15% of total duration.\n\n` +
                  `Current: ${currentResults.percentage.toFixed(1)}%\n` +
                  (currentResults.percentage < 5
                    ? 'Please select more segments.'
                    : 'Please remove some segments.')
                );
            }
        }
    });
</script>